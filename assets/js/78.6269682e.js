(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{497:function(t,e,n){"use strict";n.r(e);var s=n(20),a=Object(s.a)({},(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"internal-designs-wip"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#internal-designs-wip"}},[t._v("#")]),t._v(" Internal designs (WIP)")]),t._v(" "),n("h2",{attrs:{id:"intermediate-representation"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#intermediate-representation"}},[t._v("#")]),t._v(" Intermediate representation")]),t._v(" "),n("p",[t._v("Use "),n("code",[t._v("ti.init(print_ir=True)")]),t._v(" to print IR on the console.")]),t._v(" "),n("p",[t._v("See "),n("RouterLink",{attrs:{to:"/zh/contribution/compilation.html"}},[t._v("Life of a Taichi kernel")]),t._v(" for more details about the JIT system of Taichi.")],1),t._v(" "),n("h2",{attrs:{id:"data-structure-organization"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#data-structure-organization"}},[t._v("#")]),t._v(" Data structure organization")]),t._v(" "),n("p",[t._v("The internal organization of Taichi's data structure can be confusing. It is important to distinguish the concept of "),n("strong",[t._v("containers")]),t._v(", "),n("strong",[t._v("cells")]),t._v(", and "),n("strong",[t._v("components")]),t._v(".")]),t._v(" "),n("ul",[n("li",[t._v("A "),n("strong",[t._v("container")]),t._v(" can have multiple "),n("strong",[t._v("cells")]),t._v(". The numbers of "),n("strong",[t._v("cells")]),t._v(" are recommended to be powers of two.")]),t._v(" "),n("li",[t._v("A "),n("strong",[t._v("cell")]),t._v(" can have multiple "),n("strong",[t._v("components")]),t._v(".")]),t._v(" "),n("li",[t._v("Each "),n("strong",[t._v("component")]),t._v(" is a "),n("strong",[t._v("container")]),t._v(" of a lower-level SNode.")])]),t._v(" "),n("p",[t._v("Note that containers of "),n("code",[t._v("place")]),t._v(" SNodes do have cells. Instead, they directly contain numerical values.")]),t._v(" "),n("p",[t._v("Consider the following example:")]),t._v(" "),n("div",{staticClass:"language-python extra-class"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# misc/listgen_demo.py")]),t._v("\n\nx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("field"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ny "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("field"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nz "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("field"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nS0 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("root\nS1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" S0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pointer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nS2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" S1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dense"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nS2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("place"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" y"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# S3: x; S4: y")]),t._v("\n\nS5 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" S1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dense"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nS5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("place"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# S6: z")]),t._v("\n")])])]),n("ul",[n("li",[t._v("The whole data structure is an "),n("code",[t._v("S0root")]),t._v(" "),n("strong",[t._v("container")]),t._v(", containing\n"),n("ul",[n("li",[n("code",[t._v("1x")]),t._v(" "),n("code",[t._v("S0root")]),t._v(" "),n("strong",[t._v("cell")]),t._v(", which has only one "),n("strong",[t._v("component")]),t._v(", which is\n"),n("ul",[n("li",[t._v("An "),n("code",[t._v("S1pointer")]),t._v(" "),n("strong",[t._v("container")]),t._v(", containing\n"),n("ul",[n("li",[t._v("4x "),n("code",[t._v("S1pointer")]),t._v(" "),n("strong",[t._v("cells")]),t._v(", each with two "),n("strong",[t._v("components")]),t._v(", which are\n"),n("ul",[n("li",[t._v("An "),n("code",[t._v("S2dense")]),t._v(" "),n("strong",[t._v("container")]),t._v(", containing\n"),n("ul",[n("li",[t._v("2x "),n("code",[t._v("S2dense")]),t._v(" "),n("strong",[t._v("cells")]),t._v(", each with two "),n("strong",[t._v("components")]),t._v(", which are\n"),n("ul",[n("li",[t._v("An "),n("code",[t._v("S3place_x")]),t._v(" container which directly contains a "),n("code",[t._v("x: ti.i32")]),t._v(" value")]),t._v(" "),n("li",[t._v("An "),n("code",[t._v("S4place_y")]),t._v(" container which directly contains a "),n("code",[t._v("y: ti.i32")]),t._v(" value")])])])])]),t._v(" "),n("li",[t._v("An "),n("code",[t._v("S5dense")]),t._v(" "),n("strong",[t._v("container")]),t._v(", containing\n"),n("ul",[n("li",[t._v("2x "),n("code",[t._v("S5dense")]),t._v(" "),n("strong",[t._v("cells")]),t._v(", each with one "),n("strong",[t._v("component")]),t._v(", which is\n"),n("ul",[n("li",[t._v("An "),n("code",[t._v("S6place")]),t._v(" container which directly contains a "),n("code",[t._v("z: ti.i32")]),t._v(" value")])])])])])])])])])])])])])]),t._v(" "),n("p",[t._v("The following figure shows the hierarchy of the data structure. The numbers are "),n("code",[t._v("indices")]),t._v(" of the containers and cells.")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://raw.githubusercontent.com/taichi-dev/public_files/fa03e63ca4e161318c8aa9a5db7f4a825604df88/taichi/data_structure_organization.png",alt:"image"}})]),t._v(" "),n("p",[t._v("Note that the "),n("code",[t._v("S0root")]),t._v(" container and cell do not have an "),n("code",[t._v("index")]),t._v(".")]),t._v(" "),n("p",[t._v("In summary, we will have the following containers:")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("1 S0root")]),t._v(" container")]),t._v(" "),n("li",[n("code",[t._v("1 S1pointer")]),t._v(" container")]),t._v(" "),n("li",[n("code",[t._v("4 S2dense")]),t._v(" containers")]),t._v(" "),n("li",[n("code",[t._v("4 S5dense")]),t._v(" containers")]),t._v(" "),n("li",[n("code",[t._v("8 S3place_x")]),t._v(" containers, each directly contains an "),n("code",[t._v("i32")]),t._v(" value")]),t._v(" "),n("li",[n("code",[t._v("8 S4place_y")]),t._v(" containers, each directly contains an "),n("code",[t._v("i32")]),t._v(" value")]),t._v(" "),n("li",[n("code",[t._v("8 S6place_z")]),t._v(" containers, each directly contains an "),n("code",[t._v("i32")]),t._v(" value")])]),t._v(" "),n("p",[t._v("... and the following cells:")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("1 S0root")]),t._v(" cell")]),t._v(" "),n("li",[n("code",[t._v("4 S1pointer")]),t._v(" cells")]),t._v(" "),n("li",[n("code",[t._v("8 S2dense")]),t._v(" cells")]),t._v(" "),n("li",[n("code",[t._v("8 S5dense")]),t._v(" cells")])]),t._v(" "),n("p",[t._v("Again, note that "),n("code",[t._v("S3place_x, S4place_x, S6place_x")]),t._v(" SNodes do "),n("strong",[t._v("not")]),t._v(" have corresponding cells.")]),t._v(" "),n("p",[t._v("In struct compilers, each SNode has two types: "),n("code",[t._v("container")]),t._v(" type and "),n("code",[t._v("cell")]),t._v(" type. "),n("strong",[t._v("Components")]),t._v(" of a higher level SNode "),n("strong",[t._v("cell")]),t._v(" are "),n("strong",[t._v("containers")]),t._v(" of a lower level SNode.")]),t._v(" "),n("p",[t._v("Note that "),n("strong",[t._v("cells")]),t._v(" are never exposed to end-users.")]),t._v(" "),n("p",[n("strong",[t._v("List generation")]),t._v(" generates lists of SNode "),n("strong",[t._v("containers")]),t._v(" (instead of SNode "),n("strong",[t._v("cells")]),t._v(").")]),t._v(" "),n("div",{staticClass:"custom-block note"},[n("p",{staticClass:"custom-block-title"},[t._v("注解")]),t._v(" "),n("p",[t._v("We are on our way to remove usages of "),n("strong",[t._v("children")]),t._v(", "),n("strong",[t._v("instances")]),t._v(", and "),n("strong",[t._v("elements")]),t._v(" in Taichi. These are very ambiguous terms.")])]),t._v(" "),n("h2",{attrs:{id:"list-generation-wip"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#list-generation-wip"}},[t._v("#")]),t._v(" List generation (WIP)")]),t._v(" "),n("p",[t._v("Struct-fors in Taichi loop over all active elements of a (sparse) data structure "),n("strong",[t._v("in parallel")]),t._v(". Evenly distributing work onto processor cores is challenging on sparse data structures: naively splitting an irregular tree into pieces can easily lead to partitions with drastically different numbers of leaf elements.")]),t._v(" "),n("p",[t._v("Our strategy is to generate lists of active SNode elements layer by layer. The list generation computation happens on the same device as normal computation kernels, depending on the "),n("code",[t._v("arch")]),t._v(" argument when the user calls "),n("code",[t._v("ti.init")]),t._v(".")]),t._v(" "),n("p",[t._v("List generations flatten the data structure leaf elements into a 1D dense array, circumventing the irregularity of incomplete trees. Then we can simply invoke a regular "),n("strong",[t._v("parallel for")]),t._v(" over the list.")]),t._v(" "),n("p",[t._v("For example,")]),t._v(" "),n("div",{staticClass:"language-python extra-class"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# misc/listgen_demo.py")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" taichi "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" ti\n\nti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("init"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("print_ir"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("field"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nS0 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("root\nS1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" S0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dense"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nS2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" S1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bitmasked"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nS2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("place"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kernel")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nfunc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("gives you the following IR:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$0 = offloaded clear_list S1dense\n$1 = offloaded listgen S0root->S1dense\n$2 = offloaded clear_list S2bitmasked\n$3 = offloaded listgen S1dense->S2bitmasked\n$4 = offloaded struct_for(S2bitmasked) block_dim=0 {\n  <i32 x1> $5 = loop index 0\n  print i, $5\n}\n")])])]),n("p",[t._v("Note that "),n("code",[t._v("func")]),t._v(" leads to two list generations:")]),t._v(" "),n("ul",[n("li",[t._v("(Tasks "),n("code",[t._v("$0")]),t._v(" and "),n("code",[t._v("$1")]),t._v(") based on the list of "),n("code",[t._v("root")]),t._v(" node ("),n("code",[t._v("S0")]),t._v("), generate the list of the "),n("code",[t._v("dense")]),t._v(" nodes ("),n("code",[t._v("S1")]),t._v(");")]),t._v(" "),n("li",[t._v("(Tasks "),n("code",[t._v("$2")]),t._v(" and "),n("code",[t._v("$3")]),t._v(") based on the list of "),n("code",[t._v("dense")]),t._v(" nodes ("),n("code",[t._v("S1")]),t._v("), generate the list of "),n("code",[t._v("bitmasked")]),t._v(" nodes ("),n("code",[t._v("S2")]),t._v(").")])]),t._v(" "),n("p",[t._v("The list of "),n("code",[t._v("root")]),t._v(" node always has exactly one element (instance), so we never clear or re-generate this list.")]),t._v(" "),n("div",{staticClass:"custom-block note"},[n("p",{staticClass:"custom-block-title"},[t._v("注解")]),t._v(" "),n("p",[t._v("The list of "),n("code",[t._v("place")]),t._v(" (leaf) nodes (e.g., "),n("code",[t._v("S3")]),t._v(" in this example) is never generated. Instead, we simply loop over the list of their parent nodes, and for each parent node we enumerate the "),n("code",[t._v("place")]),t._v(" nodes on-the-fly (without actually generating a list).")]),t._v(" "),n("p",[t._v("The motivation for this design is to amortize list generation overhead. Generating one list element per leaf node ("),n("code",[t._v("place")]),t._v(" SNode) element is too expensive, likely much more expensive than the essential computation happening on the leaf element. Therefore we only generate their parent element list, so that the list generation cost is amortized over multiple child elements of a second-to-last-level SNode element.")]),t._v(" "),n("p",[t._v("In the example above, although we have "),n("code",[t._v("16")]),t._v(" instances of "),n("code",[t._v("x")]),t._v(", we only generate a list of "),n("code",[t._v("4")]),t._v(" "),n("code",[t._v("bitmasked")]),t._v(" nodes (and "),n("code",[t._v("1")]),t._v(" "),n("code",[t._v("dense")]),t._v(" node).")])]),t._v(" "),n("h2",{attrs:{id:"statistics"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#statistics"}},[t._v("#")]),t._v(" Statistics")]),t._v(" "),n("p",[t._v("In some cases, it is helpful to gather certain quantitative information about internal events during Taichi program execution. The "),n("code",[t._v("Statistics")]),t._v(" class is designed for this purpose.")]),t._v(" "),n("p",[t._v("Usage:")]),t._v(" "),n("div",{staticClass:"language-cpp extra-class"},[n("pre",{pre:!0,attrs:{class:"language-cpp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"taichi/util/statistics.h"')])]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// add 1.0 to counter "codegen_offloaded_tasks"')]),t._v("\ntaichi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("stat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"codegen_offloaded_tasks"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// add the number of statements in "ir" to counter "codegen_statements"')]),t._v("\ntaichi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("stat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"codegen_statements"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" irpass"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("analysis"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("count_statements")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ir"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("Note the keys are "),n("code",[t._v("std::string")]),t._v(" and values are "),n("code",[t._v("double")]),t._v(".")]),t._v(" "),n("p",[t._v("To print out all statistics in Python:")]),t._v(" "),n("div",{staticClass:"language-python extra-class"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("print_stat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h2",{attrs:{id:"why-python-frontend"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#why-python-frontend"}},[t._v("#")]),t._v(" Why Python frontend")]),t._v(" "),n("p",[t._v("Embedding Taichi in "),n("code",[t._v("python")]),t._v(" has the following advantages:")]),t._v(" "),n("ul",[n("li",[t._v("Easy to learn. Taichi has a very similar syntax to Python.")]),t._v(" "),n("li",[t._v("Easy to run. No ahead-of-time compilation is needed.")]),t._v(" "),n("li",[t._v("This design allows people to reuse existing python infrastructure:\n"),n("ul",[n("li",[t._v("IDEs. A python IDE mostly works for Taichi with syntax highlighting, syntax checking, and autocomplete.")]),t._v(" "),n("li",[t._v("Package manager (pip). A developed Taichi application and be easily submitted to "),n("code",[t._v("PyPI")]),t._v(" and others can easily set it up with "),n("code",[t._v("pip")]),t._v(".")]),t._v(" "),n("li",[t._v("Existing packages. Interacting with other python components (e.g. "),n("code",[t._v("matplotlib")]),t._v(" and "),n("code",[t._v("numpy")]),t._v(") is just trivial.")])])]),t._v(" "),n("li",[t._v("The built-in AST manipulation tools in "),n("code",[t._v("python")]),t._v(" allow us to do magical things, as long as the kernel body can be parsed by the Python parser.")])]),t._v(" "),n("p",[t._v("However, this design has drawbacks as well:")]),t._v(" "),n("ul",[n("li",[t._v("Taichi kernels must parse-able by Python parsers. This means Taichi syntax cannot go beyond Python syntax.\n"),n("ul",[n("li",[t._v("For example, indexing is always needed when accessing elements in Taichi fields, even if the fields is 0D. Use "),n("code",[t._v("x[None] = 123")]),t._v(" to set the value in "),n("code",[t._v("x")]),t._v(" if "),n("code",[t._v("x")]),t._v(" is 0D. This is because "),n("code",[t._v("x = 123")]),t._v(" will set "),n("code",[t._v("x")]),t._v(" itself (instead of its containing value) to be the constant "),n("code",[t._v("123")]),t._v(" in python syntax, and, unfortunately, we cannot modify this behavior.")])])]),t._v(" "),n("li",[t._v("Python has relatively low performance. This can cause a performance issue when initializing large Taichi fields with pure python scripts. A Taichi kernel should be used to initialize a huge fields.")])]),t._v(" "),n("h2",{attrs:{id:"virtual-indices-v-s-physical-indices"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#virtual-indices-v-s-physical-indices"}},[t._v("#")]),t._v(" Virtual indices v.s. physical indices")]),t._v(" "),n("p",[t._v("In Taichi, "),n("em",[t._v("virtual indices")]),t._v(" are used to locate elements in fields, and "),n("em",[t._v("physical indices")]),t._v(" are used to specify data layouts in memory.")]),t._v(" "),n("p",[t._v("For example,")]),t._v(" "),n("ul",[n("li",[t._v("In "),n("code",[t._v("a[i, j, k]")]),t._v(", "),n("code",[t._v("i")]),t._v(", "),n("code",[t._v("j")]),t._v(", and "),n("code",[t._v("k")]),t._v(" are "),n("strong",[t._v("virtual")]),t._v(" indices.")]),t._v(" "),n("li",[t._v("In "),n("code",[t._v("for i, j in x:")]),t._v(", "),n("code",[t._v("i")]),t._v(" and "),n("code",[t._v("j")]),t._v(" are "),n("strong",[t._v("virtual")]),t._v(" indices.")]),t._v(" "),n("li",[n("code",[t._v("ti.i, ti.j, ti.k, ti.l, ...")]),t._v(" are "),n("strong",[t._v("physical")]),t._v(" indices.")]),t._v(" "),n("li",[t._v("In struct-for statements, "),n("code",[t._v("LoopIndexStmt::index")]),t._v(" is a "),n("strong",[t._v("physical")]),t._v(" index.")])]),t._v(" "),n("p",[t._v("The mapping between virtual indices and physical indices for each "),n("code",[t._v("SNode")]),t._v(" is stored in "),n("code",[t._v("SNode::physical_index_position")]),t._v(". I.e., "),n("code",[t._v("physical_index_position[i]")]),t._v(" answers the question: "),n("strong",[t._v("which physical index does the i-th virtual index")]),t._v(" correspond to?")]),t._v(" "),n("p",[t._v("Each "),n("code",[t._v("SNode")]),t._v(" can have a different virtual-to-physical mapping. "),n("code",[t._v("physical_index_position[i] == -1")]),t._v(" means the "),n("code",[t._v("i")]),t._v("-th virtual index does not corrspond to any physical index in this "),n("code",[t._v("SNode")]),t._v(".")]),t._v(" "),n("p",[n("code",[t._v("SNode")]),t._v(" s in handy dense fields (i.e., "),n("code",[t._v("a = ti.field(ti.i32, shape=(128, 256, 512))")]),t._v(") have "),n("strong",[t._v("trivial")]),t._v(" virtual-to-physical mapping, e.g. "),n("code",[t._v("physical_index_position[i] = i")]),t._v(".")]),t._v(" "),n("p",[t._v("However, more complex data layouts, such as column-major 2D fields can lead to "),n("code",[t._v("SNodes")]),t._v(" with "),n("code",[t._v("physical_index_position[0] = 1")]),t._v(" and "),n("code",[t._v("physical_index_position[1] = 0")]),t._v(".")]),t._v(" "),n("div",{staticClass:"language-python extra-class"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[t._v("a "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("field"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("f32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" shape"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nb "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("field"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("f32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dense"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dense"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("place"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nti"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_runtime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("materialize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmapping_a "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("snode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("physical_index_position"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" mapping_a "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nmapping_b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("snode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("physical_index_position"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" mapping_b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Note that b is column-major:")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# the virtual first index exposed to the user comes second in memory layout.")]),t._v("\n")])])]),n("p",[t._v("Taichi supports up to 8 ("),n("code",[t._v("constexpr int taichi_max_num_indices = 8")]),t._v(") virtual indices and physical indices.")])])}),[],!1,null,null,null);e.default=a.exports}}]);