<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Internal designs (WIP) | Taichi</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="The Taichi Programming Language">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="og:locale" content="en_US">
    
    <link rel="preload" href="/assets/css/0.styles.b08593d8.css" as="style"><link rel="preload" href="/assets/js/app.59fd6fb1.js" as="script"><link rel="preload" href="/assets/js/5.080877bc.js" as="script"><link rel="preload" href="/assets/js/25.93e0247b.js" as="script"><link rel="prefetch" href="/assets/js/1.e5c9f45c.js"><link rel="prefetch" href="/assets/js/10.63d3cf82.js"><link rel="prefetch" href="/assets/js/100.321ee228.js"><link rel="prefetch" href="/assets/js/101.ca84f615.js"><link rel="prefetch" href="/assets/js/102.c005d634.js"><link rel="prefetch" href="/assets/js/103.97f6438c.js"><link rel="prefetch" href="/assets/js/104.668c4244.js"><link rel="prefetch" href="/assets/js/105.d5f7f062.js"><link rel="prefetch" href="/assets/js/106.6a6e36e3.js"><link rel="prefetch" href="/assets/js/107.bc54b431.js"><link rel="prefetch" href="/assets/js/108.d9d4d755.js"><link rel="prefetch" href="/assets/js/109.e47c8dc5.js"><link rel="prefetch" href="/assets/js/11.dedff0c7.js"><link rel="prefetch" href="/assets/js/110.11a597a3.js"><link rel="prefetch" href="/assets/js/111.eb95c668.js"><link rel="prefetch" href="/assets/js/112.8f9aa888.js"><link rel="prefetch" href="/assets/js/113.84e8342b.js"><link rel="prefetch" href="/assets/js/114.3240d5df.js"><link rel="prefetch" href="/assets/js/115.5cd8f9a7.js"><link rel="prefetch" href="/assets/js/116.fa829f4d.js"><link rel="prefetch" href="/assets/js/117.e949d2b8.js"><link rel="prefetch" href="/assets/js/118.b838030e.js"><link rel="prefetch" href="/assets/js/119.3e064d4e.js"><link rel="prefetch" href="/assets/js/12.90a21ef0.js"><link rel="prefetch" href="/assets/js/120.18149c28.js"><link rel="prefetch" href="/assets/js/121.91e64eb7.js"><link rel="prefetch" href="/assets/js/13.f437f6cb.js"><link rel="prefetch" href="/assets/js/14.6b96fdb4.js"><link rel="prefetch" href="/assets/js/15.8df75154.js"><link rel="prefetch" href="/assets/js/16.9b549176.js"><link rel="prefetch" href="/assets/js/17.4dc6aece.js"><link rel="prefetch" href="/assets/js/18.938c8675.js"><link rel="prefetch" href="/assets/js/19.929a4a22.js"><link rel="prefetch" href="/assets/js/2.4db73bc4.js"><link rel="prefetch" href="/assets/js/20.79016e42.js"><link rel="prefetch" href="/assets/js/21.e4060e84.js"><link rel="prefetch" href="/assets/js/22.c99f92c4.js"><link rel="prefetch" href="/assets/js/23.ac76eac1.js"><link rel="prefetch" href="/assets/js/24.f3ccf200.js"><link rel="prefetch" href="/assets/js/26.8301bb8d.js"><link rel="prefetch" href="/assets/js/27.aed18eb1.js"><link rel="prefetch" href="/assets/js/28.bbee75ed.js"><link rel="prefetch" href="/assets/js/29.8b8919bc.js"><link rel="prefetch" href="/assets/js/30.f60923c8.js"><link rel="prefetch" href="/assets/js/31.f43ac168.js"><link rel="prefetch" href="/assets/js/32.586551aa.js"><link rel="prefetch" href="/assets/js/33.72723ac6.js"><link rel="prefetch" href="/assets/js/34.0b0b7741.js"><link rel="prefetch" href="/assets/js/35.7e5d0389.js"><link rel="prefetch" href="/assets/js/36.bbea2f59.js"><link rel="prefetch" href="/assets/js/37.29d882b2.js"><link rel="prefetch" href="/assets/js/38.931e3cc8.js"><link rel="prefetch" href="/assets/js/39.ca922070.js"><link rel="prefetch" href="/assets/js/40.6c3d59e2.js"><link rel="prefetch" href="/assets/js/41.60494ab3.js"><link rel="prefetch" href="/assets/js/42.31179ab1.js"><link rel="prefetch" href="/assets/js/43.da017430.js"><link rel="prefetch" href="/assets/js/44.73d6662a.js"><link rel="prefetch" href="/assets/js/45.72bebcd9.js"><link rel="prefetch" href="/assets/js/46.c59a47dd.js"><link rel="prefetch" href="/assets/js/47.58da5713.js"><link rel="prefetch" href="/assets/js/48.4d0125d0.js"><link rel="prefetch" href="/assets/js/49.7fdf880c.js"><link rel="prefetch" href="/assets/js/50.8a72eff0.js"><link rel="prefetch" href="/assets/js/51.cefbd987.js"><link rel="prefetch" href="/assets/js/52.01ea5e3a.js"><link rel="prefetch" href="/assets/js/53.fd338b48.js"><link rel="prefetch" href="/assets/js/54.49823d90.js"><link rel="prefetch" href="/assets/js/55.fd3daeef.js"><link rel="prefetch" href="/assets/js/56.36eea25b.js"><link rel="prefetch" href="/assets/js/57.13bf7e2a.js"><link rel="prefetch" href="/assets/js/58.f76ecc8c.js"><link rel="prefetch" href="/assets/js/59.d0d81a01.js"><link rel="prefetch" href="/assets/js/6.18d71df6.js"><link rel="prefetch" href="/assets/js/60.1e50815d.js"><link rel="prefetch" href="/assets/js/61.89013eac.js"><link rel="prefetch" href="/assets/js/62.54f52f64.js"><link rel="prefetch" href="/assets/js/63.ea3d19ef.js"><link rel="prefetch" href="/assets/js/64.bdad9f0b.js"><link rel="prefetch" href="/assets/js/65.fe2bb921.js"><link rel="prefetch" href="/assets/js/66.1bf5152f.js"><link rel="prefetch" href="/assets/js/67.3a1cc0aa.js"><link rel="prefetch" href="/assets/js/68.723f10ec.js"><link rel="prefetch" href="/assets/js/69.7fd7351b.js"><link rel="prefetch" href="/assets/js/7.d8e2bbde.js"><link rel="prefetch" href="/assets/js/70.3e0b791e.js"><link rel="prefetch" href="/assets/js/71.b30f5c4d.js"><link rel="prefetch" href="/assets/js/72.7a273467.js"><link rel="prefetch" href="/assets/js/73.345b9d5a.js"><link rel="prefetch" href="/assets/js/74.0f39ef9b.js"><link rel="prefetch" href="/assets/js/75.d9fe506c.js"><link rel="prefetch" href="/assets/js/76.965a3551.js"><link rel="prefetch" href="/assets/js/77.6e35a657.js"><link rel="prefetch" href="/assets/js/78.6269682e.js"><link rel="prefetch" href="/assets/js/79.e3f06abb.js"><link rel="prefetch" href="/assets/js/8.f3cce39d.js"><link rel="prefetch" href="/assets/js/80.75e1964e.js"><link rel="prefetch" href="/assets/js/81.a861ad93.js"><link rel="prefetch" href="/assets/js/82.4591d522.js"><link rel="prefetch" href="/assets/js/83.1209684a.js"><link rel="prefetch" href="/assets/js/84.0ce9655e.js"><link rel="prefetch" href="/assets/js/85.fb670f63.js"><link rel="prefetch" href="/assets/js/86.0dd493d9.js"><link rel="prefetch" href="/assets/js/87.bffe8e32.js"><link rel="prefetch" href="/assets/js/88.6daa59c9.js"><link rel="prefetch" href="/assets/js/89.57eb10ea.js"><link rel="prefetch" href="/assets/js/9.bbfb438a.js"><link rel="prefetch" href="/assets/js/90.49b6f8c0.js"><link rel="prefetch" href="/assets/js/91.c1eda5fa.js"><link rel="prefetch" href="/assets/js/92.fca7eb94.js"><link rel="prefetch" href="/assets/js/93.79f5bca6.js"><link rel="prefetch" href="/assets/js/94.a91735e4.js"><link rel="prefetch" href="/assets/js/95.392e91ad.js"><link rel="prefetch" href="/assets/js/96.01832884.js"><link rel="prefetch" href="/assets/js/97.9c92bd79.js"><link rel="prefetch" href="/assets/js/98.f83e4f4d.js"><link rel="prefetch" href="/assets/js/99.0ae1bacd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.872458a0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b08593d8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo_medium.png" alt="Taichi" class="logo"> <span class="site-name can-hide">Taichi</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Documentation" class="dropdown-title"><span class="title">Documentation</span> <span class="arrow down"></span></button> <button type="button" aria-label="Documentation" class="mobile-dropdown-title"><span class="title">Documentation</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/develop/documentation/overview/overview.html" class="nav-link">
  develop
</a></li></ul></div></div><div class="nav-item"><a href="/tutorials/" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Learn More" class="dropdown-title"><span class="title">Learn More</span> <span class="arrow down"></span></button> <button type="button" aria-label="Learn More" class="mobile-dropdown-title"><span class="title">Learn More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Explore
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/gallery/" class="nav-link">
  Gallery
</a></li><li class="dropdown-subitem"><a href="/research/" class="nav-link">
  Research
</a></li></ul></li><li class="dropdown-item"><h4>
          Resources
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/contribution/" class="nav-link router-link-active">
  Contribution Guide
</a></li><li class="dropdown-subitem"><a href="/events/" class="nav-link">
  Events
</a></li><li class="dropdown-subitem"><a href="https://github.com/taichi-dev/taichi/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Changelog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          FAQ
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/faq/" class="nav-link">
  FAQ
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://forum.taichi.graphics/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Forum
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/community/" class="nav-link">
  Community
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/contribution/internal.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/contribution/internal.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/taichi-dev/taichi" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Documentation" class="dropdown-title"><span class="title">Documentation</span> <span class="arrow down"></span></button> <button type="button" aria-label="Documentation" class="mobile-dropdown-title"><span class="title">Documentation</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/develop/documentation/overview/overview.html" class="nav-link">
  develop
</a></li></ul></div></div><div class="nav-item"><a href="/tutorials/" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Learn More" class="dropdown-title"><span class="title">Learn More</span> <span class="arrow down"></span></button> <button type="button" aria-label="Learn More" class="mobile-dropdown-title"><span class="title">Learn More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Explore
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/gallery/" class="nav-link">
  Gallery
</a></li><li class="dropdown-subitem"><a href="/research/" class="nav-link">
  Research
</a></li></ul></li><li class="dropdown-item"><h4>
          Resources
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/contribution/" class="nav-link router-link-active">
  Contribution Guide
</a></li><li class="dropdown-subitem"><a href="/events/" class="nav-link">
  Events
</a></li><li class="dropdown-subitem"><a href="https://github.com/taichi-dev/taichi/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Changelog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          FAQ
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/faq/" class="nav-link">
  FAQ
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://forum.taichi.graphics/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Forum
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/community/" class="nav-link">
  Community
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/contribution/internal.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/contribution/internal.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/taichi-dev/taichi" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Contribution Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/contribution/dev_install.html" class="sidebar-link">Developer installation</a></li><li><a href="/contribution/contributor_guide.html" class="sidebar-link">Contribution guidelines</a></li><li><a href="/contribution/doc_writing.html" class="sidebar-link">Documentation Writing Guide</a></li><li><a href="/contribution/write_test.html" class="sidebar-link">Workflow for writing a Python test</a></li><li><a href="/contribution/utilities.html" class="sidebar-link">Developer utilities</a></li><li><a href="/contribution/profiler.html" class="sidebar-link">Profiler</a></li><li><a href="/contribution/cpp_style.html" class="sidebar-link">C++ style</a></li><li><a href="/contribution/compilation.html" class="sidebar-link">Life of a Taichi kernel</a></li><li><a href="/contribution/internal.html" aria-current="page" class="active sidebar-link">Internal designs (WIP)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/contribution/internal.html#intermediate-representation" class="sidebar-link">Intermediate representation</a></li><li class="sidebar-sub-header"><a href="/contribution/internal.html#data-structure-organization" class="sidebar-link">Data structure organization</a></li><li class="sidebar-sub-header"><a href="/contribution/internal.html#list-generation-wip" class="sidebar-link">List generation (WIP)</a></li><li class="sidebar-sub-header"><a href="/contribution/internal.html#statistics" class="sidebar-link">Statistics</a></li><li class="sidebar-sub-header"><a href="/contribution/internal.html#why-python-frontend" class="sidebar-link">Why Python frontend</a></li><li class="sidebar-sub-header"><a href="/contribution/internal.html#virtual-indices-v-s-physical-indices" class="sidebar-link">Virtual indices v.s. physical indices</a></li></ul></li><li><a href="/contribution/versioning_releases.html" class="sidebar-link">Versioning and releases</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="internal-designs-wip"><a href="#internal-designs-wip" class="header-anchor">#</a> Internal designs (WIP)</h1> <h2 id="intermediate-representation"><a href="#intermediate-representation" class="header-anchor">#</a> Intermediate representation</h2> <p>Use <code>ti.init(print_ir=True)</code> to print IR on the console.</p> <p>See <a href="/contribution/compilation.html">Life of a Taichi kernel</a> for more details about
the JIT system of Taichi.</p> <h2 id="data-structure-organization"><a href="#data-structure-organization" class="header-anchor">#</a> Data structure organization</h2> <p>The internal organization of Taichi's data structure can be confusing.
It is important to distinguish the concept of <strong>containers</strong>, <strong>cells</strong>,
and <strong>components</strong>.</p> <ul><li>A <strong>container</strong> can have multiple <strong>cells</strong>. The numbers of
<strong>cells</strong> are recommended to be powers of two.</li> <li>A <strong>cell</strong> can have multiple <strong>components</strong>.</li> <li>Each <strong>component</strong> is a <strong>container</strong> of a lower-level SNode.</li></ul> <p>Note that containers of <code>place</code> SNodes do have cells. Instead, they
directly contain numerical values.</p> <p>Consider the following example:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># misc/listgen_demo.py</span>

x <span class="token operator">=</span> ti<span class="token punctuation">.</span>field<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i32<span class="token punctuation">)</span>
y <span class="token operator">=</span> ti<span class="token punctuation">.</span>field<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i32<span class="token punctuation">)</span>
z <span class="token operator">=</span> ti<span class="token punctuation">.</span>field<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i32<span class="token punctuation">)</span>

S0 <span class="token operator">=</span> ti<span class="token punctuation">.</span>root
S1 <span class="token operator">=</span> S0<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

S2 <span class="token operator">=</span> S1<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
S2<span class="token punctuation">.</span>place<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token comment"># S3: x; S4: y</span>

S5 <span class="token operator">=</span> S1<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
S5<span class="token punctuation">.</span>place<span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token comment"># S6: z</span>
</code></pre></div><ul><li>The whole data structure is an <code>S0root</code> <strong>container</strong>, containing
<ul><li><code>1x</code> <code>S0root</code> <strong>cell</strong>, which has only one <strong>component</strong>, which
is
<ul><li>An <code>S1pointer</code> <strong>container</strong>, containing
<ul><li>4x <code>S1pointer</code> <strong>cells</strong>, each with two <strong>components</strong>,
which are
<ul><li>An <code>S2dense</code> <strong>container</strong>, containing
<ul><li>2x <code>S2dense</code> <strong>cells</strong>, each with two
<strong>components</strong>, which are
<ul><li>An <code>S3place_x</code> container which directly
contains a <code>x: ti.i32</code> value</li> <li>An <code>S4place_y</code> container which directly
contains a <code>y: ti.i32</code> value</li></ul></li></ul></li> <li>An <code>S5dense</code> <strong>container</strong>, containing
<ul><li>2x <code>S5dense</code> <strong>cells</strong>, each with one
<strong>component</strong>, which is
<ul><li>An <code>S6place</code> container which directly
contains a <code>z: ti.i32</code> value</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul> <p>The following figure shows the hierarchy of the data structure. The
numbers are <code>indices</code> of the containers and cells.</p> <p><img src="https://raw.githubusercontent.com/taichi-dev/public_files/fa03e63ca4e161318c8aa9a5db7f4a825604df88/taichi/data_structure_organization.png" alt="image"></p> <p>Note that the <code>S0root</code> container and cell do not have an <code>index</code>.</p> <p>In summary, we will have the following containers:</p> <ul><li><code>1 S0root</code> container</li> <li><code>1 S1pointer</code> container</li> <li><code>4 S2dense</code> containers</li> <li><code>4 S5dense</code> containers</li> <li><code>8 S3place_x</code> containers, each directly contains an <code>i32</code> value</li> <li><code>8 S4place_y</code> containers, each directly contains an <code>i32</code> value</li> <li><code>8 S6place_z</code> containers, each directly contains an <code>i32</code> value</li></ul> <p>... and the following cells:</p> <ul><li><code>1 S0root</code> cell</li> <li><code>4 S1pointer</code> cells</li> <li><code>8 S2dense</code> cells</li> <li><code>8 S5dense</code> cells</li></ul> <p>Again, note that <code>S3place_x, S4place_x, S6place_x</code> SNodes do <strong>not</strong>
have corresponding cells.</p> <p>In struct compilers, each SNode has two types: <code>container</code> type and
<code>cell</code> type. <strong>Components</strong> of a higher level SNode <strong>cell</strong> are
<strong>containers</strong> of a lower level SNode.</p> <p>Note that <strong>cells</strong> are never exposed to end-users.</p> <p><strong>List generation</strong> generates lists of SNode <strong>containers</strong> (instead of
SNode <strong>cells</strong>).</p> <div class="custom-block note"><p class="custom-block-title">NOTE</p> <p>We are on our way to remove usages of <strong>children</strong>, <strong>instances</strong>, and
<strong>elements</strong> in Taichi. These are very ambiguous terms.</p></div> <h2 id="list-generation-wip"><a href="#list-generation-wip" class="header-anchor">#</a> List generation (WIP)</h2> <p>Struct-fors in Taichi loop over all active elements of a (sparse) data
structure <strong>in parallel</strong>. Evenly distributing work onto processor cores
is challenging on sparse data structures: naively splitting an irregular
tree into pieces can easily lead to partitions with drastically
different numbers of leaf elements.</p> <p>Our strategy is to generate lists of active SNode elements layer by
layer. The list generation computation happens on the same device as
normal computation kernels, depending on the <code>arch</code> argument when the
user calls <code>ti.init</code>.</p> <p>List generations flatten the data structure leaf elements into a 1D
dense array, circumventing the irregularity of incomplete trees. Then we
can simply invoke a regular <strong>parallel for</strong> over the list.</p> <p>For example,</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># misc/listgen_demo.py</span>

<span class="token keyword">import</span> taichi <span class="token keyword">as</span> ti

ti<span class="token punctuation">.</span>init<span class="token punctuation">(</span>print_ir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

x <span class="token operator">=</span> ti<span class="token punctuation">.</span>field<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i32<span class="token punctuation">)</span>

S0 <span class="token operator">=</span> ti<span class="token punctuation">.</span>root
S1 <span class="token operator">=</span> S0<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
S2 <span class="token operator">=</span> S1<span class="token punctuation">.</span>bitmasked<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
S2<span class="token punctuation">.</span>place<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>kernel</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

func<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>gives you the following IR:</p> <div class="language- extra-class"><pre class="language-text"><code>$0 = offloaded clear_list S1dense
$1 = offloaded listgen S0root-&gt;S1dense
$2 = offloaded clear_list S2bitmasked
$3 = offloaded listgen S1dense-&gt;S2bitmasked
$4 = offloaded struct_for(S2bitmasked) block_dim=0 {
  &lt;i32 x1&gt; $5 = loop index 0
  print i, $5
}
</code></pre></div><p>Note that <code>func</code> leads to two list generations:</p> <ul><li>(Tasks <code>$0</code> and <code>$1</code>) based on the list of <code>root</code> node (<code>S0</code>),
generate the list of the <code>dense</code> nodes (<code>S1</code>);</li> <li>(Tasks <code>$2</code> and <code>$3</code>) based on the list of <code>dense</code> nodes (<code>S1</code>),
generate the list of <code>bitmasked</code> nodes (<code>S2</code>).</li></ul> <p>The list of <code>root</code> node always has exactly one element (instance), so we
never clear or re-generate this list.</p> <div class="custom-block note"><p class="custom-block-title">NOTE</p> <p>The list of <code>place</code> (leaf) nodes (e.g., <code>S3</code> in this example) is never
generated. Instead, we simply loop over the list of their parent nodes,
and for each parent node we enumerate the <code>place</code> nodes on-the-fly
(without actually generating a list).</p> <p>The motivation for this design is to amortize list generation overhead.
Generating one list element per leaf node (<code>place</code> SNode) element is too
expensive, likely much more expensive than the essential computation
happening on the leaf element. Therefore we only generate their parent
element list, so that the list generation cost is amortized over
multiple child elements of a second-to-last-level SNode element.</p> <p>In the example above, although we have <code>16</code> instances of <code>x</code>, we only
generate a list of <code>4</code> <code>bitmasked</code> nodes (and <code>1</code> <code>dense</code> node).</p></div> <h2 id="statistics"><a href="#statistics" class="header-anchor">#</a> Statistics</h2> <p>In some cases, it is helpful to gather certain quantitative information
about internal events during Taichi program execution. The <code>Statistics</code>
class is designed for this purpose.</p> <p>Usage:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;taichi/util/statistics.h&quot;</span></span>

<span class="token comment">// add 1.0 to counter &quot;codegen_offloaded_tasks&quot;</span>
taichi<span class="token operator">::</span>stat<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;codegen_offloaded_tasks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add the number of statements in &quot;ir&quot; to counter &quot;codegen_statements&quot;</span>
taichi<span class="token operator">::</span>stat<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;codegen_statements&quot;</span><span class="token punctuation">,</span> irpass<span class="token operator">::</span>analysis<span class="token operator">::</span><span class="token function">count_statements</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Note the keys are <code>std::string</code> and values are <code>double</code>.</p> <p>To print out all statistics in Python:</p> <div class="language-python extra-class"><pre class="language-python"><code>ti<span class="token punctuation">.</span>core<span class="token punctuation">.</span>print_stat<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="why-python-frontend"><a href="#why-python-frontend" class="header-anchor">#</a> Why Python frontend</h2> <p>Embedding Taichi in <code>python</code> has the following advantages:</p> <ul><li>Easy to learn. Taichi has a very similar syntax to Python.</li> <li>Easy to run. No ahead-of-time compilation is needed.</li> <li>This design allows people to reuse existing python infrastructure:
<ul><li>IDEs. A python IDE mostly works for Taichi with syntax
highlighting, syntax checking, and autocomplete.</li> <li>Package manager (pip). A developed Taichi application and be
easily submitted to <code>PyPI</code> and others can easily set it up with
<code>pip</code>.</li> <li>Existing packages. Interacting with other python components
(e.g. <code>matplotlib</code> and <code>numpy</code>) is just trivial.</li></ul></li> <li>The built-in AST manipulation tools in <code>python</code> allow us to do
magical things, as long as the kernel body can be parsed by the
Python parser.</li></ul> <p>However, this design has drawbacks as well:</p> <ul><li>Taichi kernels must parse-able by Python parsers. This means Taichi
syntax cannot go beyond Python syntax.
<ul><li>For example, indexing is always needed when accessing elements
in Taichi fields, even if the fields is 0D. Use <code>x[None] = 123</code>
to set the value in <code>x</code> if <code>x</code> is 0D. This is because <code>x = 123</code>
will set <code>x</code> itself (instead of its containing value) to be the
constant <code>123</code> in python syntax, and, unfortunately, we cannot
modify this behavior.</li></ul></li> <li>Python has relatively low performance. This can cause a performance
issue when initializing large Taichi fields with pure python
scripts. A Taichi kernel should be used to initialize a huge fields.</li></ul> <h2 id="virtual-indices-v-s-physical-indices"><a href="#virtual-indices-v-s-physical-indices" class="header-anchor">#</a> Virtual indices v.s. physical indices</h2> <p>In Taichi, <em>virtual indices</em> are used to locate elements in fields, and
<em>physical indices</em> are used to specify data layouts in memory.</p> <p>For example,</p> <ul><li>In <code>a[i, j, k]</code>, <code>i</code>, <code>j</code>, and <code>k</code> are <strong>virtual</strong> indices.</li> <li>In <code>for i, j in x:</code>, <code>i</code> and <code>j</code> are <strong>virtual</strong> indices.</li> <li><code>ti.i, ti.j, ti.k, ti.l, ...</code> are <strong>physical</strong> indices.</li> <li>In struct-for statements, <code>LoopIndexStmt::index</code> is a <strong>physical</strong>
index.</li></ul> <p>The mapping between virtual indices and physical indices for each
<code>SNode</code> is stored in <code>SNode::physical_index_position</code>. I.e.,
<code>physical_index_position[i]</code> answers the question: <strong>which physical
index does the i-th virtual index</strong> correspond to?</p> <p>Each <code>SNode</code> can have a different virtual-to-physical mapping.
<code>physical_index_position[i] == -1</code> means the <code>i</code>-th virtual index does
not corrspond to any physical index in this <code>SNode</code>.</p> <p><code>SNode</code> s in handy dense fields (i.e.,
<code>a = ti.field(ti.i32, shape=(128, 256, 512))</code>) have <strong>trivial</strong>
virtual-to-physical mapping, e.g. <code>physical_index_position[i] = i</code>.</p> <p>However, more complex data layouts, such as column-major 2D fields can
lead to <code>SNodes</code> with <code>physical_index_position[0] = 1</code> and
<code>physical_index_position[1] = 0</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code>a <span class="token operator">=</span> ti<span class="token punctuation">.</span>field<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>f32<span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

b <span class="token operator">=</span> ti<span class="token punctuation">.</span>field<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>f32<span class="token punctuation">)</span>
ti<span class="token punctuation">.</span>root<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>j<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dense<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>place<span class="token punctuation">(</span>b<span class="token punctuation">)</span>

ti<span class="token punctuation">.</span>get_runtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>materialize<span class="token punctuation">(</span><span class="token punctuation">)</span>

mapping_a <span class="token operator">=</span> a<span class="token punctuation">.</span>snode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>physical_index_position<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">assert</span> mapping_a <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>

mapping_b <span class="token operator">=</span> b<span class="token punctuation">.</span>snode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>physical_index_position<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">assert</span> mapping_b <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
<span class="token comment"># Note that b is column-major:</span>
<span class="token comment"># the virtual first index exposed to the user comes second in memory layout.</span>
</code></pre></div><p>Taichi supports up to 8 (<code>constexpr int taichi_max_num_indices = 8</code>)
virtual indices and physical indices.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/taichi-dev/taichi.graphics/edit/master/website/contribution/internal.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/20/2021, 8:59:09 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/contribution/compilation.html" class="prev">
        Life of a Taichi kernel
      </a></span> <span class="next"><a href="/contribution/versioning_releases.html">
        Versioning and releases
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.59fd6fb1.js" defer></script><script src="/assets/js/5.080877bc.js" defer></script><script src="/assets/js/25.93e0247b.js" defer></script>
  </body>
</html>
